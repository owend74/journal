# Week Beginning 8th April 2019
## Monday 8th

* Worked on [MB-33683](https://issues.couchbase.com/browse/MB-33683) by learning rebalance behaviour in more detail.  Watched the rebalance [video](https://drive.google.com/open?id=0B6AAZxJB1JWOdFVFcXZRb1FvWmM) from Poonam.  Note:  Slides available from Paolo on email sent 11/9/18. Also updated the MB asking ns_server team why we go from pending to replica.
* Returned to work on expel code.  Focused on test case where we have the follow checkpoint / cursor set-up.  The interesting point is that we have two cursor both pointing to the same seqno (one pointing to a mutation and on pointing to a metadata), and the cursor pointing to the metadata is **after** the cursor pointing to the mutation.

```
1000 - dummy item
1001 - checkpoint start
1001 - set VB state
1001 - mutation  <<<<<<< dcpCursor2
1001 - checkpoint end  <<<<<<< dcpCursor1

1001 - dummy item
1002 - checkpoint start
1002 - mutation   <<<<<<< persistenceCursor
``` 

In this case we should not be able to expel any items however the current code allows us to expel 4 items (dummy, checkpoint_start, set VB state, and mutation). However the shared pointier of the dummy was set to where the mutation was and so it will not be expelled (as it will still have a reference).

Also why developing the test case came across a potential bug in checkpoint, where we have seqno out of order in a checkpoint.

```
checkpoint = CheckpointManager[0x10e209900] with numItems:6 checkpoints:2
    Checkpoint[0x10e209a80] with seqno:{1001,1001} state:CHECKPOINT_CLOSED items:[
        {1000,empty,cid:0x1:empty,102,[m]}
        {1001,checkpoint_start,cid:0x1:checkpoint_start,113,[m]}
        {1001,mutation,cid:0x0:key0,101,}
        {1002,set_vbucket_state,cid:0x1:set_vbucket_state,114,[m]}
        {1001,checkpoint_end,cid:0x1:checkpoint_end,111,[m]}
]
    Checkpoint[0x10e209600] with seqno:{1002,1002} state:CHECKPOINT_OPEN items:[
        {1001,empty,cid:0x1:empty,102,[m]}
        {1002,checkpoint_start,cid:0x1:checkpoint_start,113,[m]}
        {1002,mutation,cid:0x0:key1,101,}
]
```

The above state wass generated by having checkpoints contain a maximum of 1 mutation and then:

1. Adding an item
2. Adding a set VB state
3. Adding another item

**Actions**

* Address the accounting for number of items expelled
* Address the issue of expelling where metadata item is after the mutation, but have the same seqno. 
* Investigate the potential bug with Checkpoint.